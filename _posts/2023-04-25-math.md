---
layout: post
title: Normalizing Flow (tmp)
date: 2023-04-25 11:12:00-0400
description: an explanation for normalizing flow
tags: generative_model math
categories: sample-posts
related_posts: false
---

원 논문 : [Variational Inference with Normalizing Flows, 2015](https://arxiv.org/abs/1505.05770)

일반적으로 variational inference에서 posterior distribution로 간단한 family의 distribution을 사용한다. 이 논문의 목적은 variational inference를 위해 rich posterior approximation을 구축하는 방법을 찾는 것이다. 저자는 normalizing flow라는 방법을 제안하는데, 이는 간단한 확률밀도를 갖는 분포에서 출발하여 복잡한 분포를 표현할 수 있을 때까지 invertible transformation을 순차적으로 적용한다. Normalizing flow라는 방법이 어떻게 복잡한 posterior를 표현할 수 있게 되는지 알아보자.

# Variational Inference
Variational inference framework에서는 lower bound를 최대화하는 방식으로 $$\mathbf{x}$$에 대한 marginal likelihood를 최대화한다.
\begin{equation}
\log p_\theta(\mathbf{x})\geq -D_{KL}[q_\phi(\mathbf{z}|\mathbf{x]})||p(\mathbf{z})]+E_q[\log(\mathbf{x}|\mathbf{z})]
\label{eq:elbo}
\end{equation}
이 lower bound가 익히 알려진 evidence lower bound(ELBO)이다. ELBO에서 approximate posterior distribution $q(\cdot)$을 설정하는 것이 큰 문제인데, 이 논문의 초점이 되는 부분이다.

# Normalizing Flows
Eq \ref{eq:elbo}의 bound에서 최적의 variational distribution은 $$q_\phi(\mathbf{z}|\mathbf{x})=p_\theta(\mathbf{z}|\mathbf{x})$$일 때 성립한다. 하지만 independent Gaussian과 같은 일반적인 $$q(\cdot)$$의 세팅으로는 이러한 조건을 충족시킬 수 없다. 어떻게 $$q(\cdot)$$를 모델링하면 flexible하게 만들 수 있을까?

확률분포 $$q(\mathbf{z})$$를 갖는 간단한 random variable $$\mathbf{z}$$에 대한 변수변환(change of variables)를 이용해 접근해보자. 먼저 invertible, smooth mapping $$f:\mathbb{R}^d\rightarrow\mathbb{R}^d$$를 고려하자. Inverse map은 $$g$$로 표현하자($$g\circ f(\mathbf{z})=\mathbf{z}$$). 이 transformation을 통해 우리는 $$\mathbf{z}^'=f(\mathbf{z})$$를 생각할 수 있다.

\begin{equation}
q(\mathbf{z}^')=q(\mathbf{z})|\det\pdv{f^{-1}}{\mathbf{z}^'}|=|\det\pdv{f}{\mathbf{z}}|^{-1}
\end{equation}

이 변수변환을 순차적으로(successively) 고려해보자. $$K$$개의 $$f_k$$를 고려하여 다음과 같이 random variable과 확률분포를 정의할 수 있다.

\begin{equation}
\mathbf{z}_K = f_K\circ\cdots\circ f_1(\mathbf{z}_0) \\
\ln q_K(\mathbf{z}_K)=\ln q_0(\mathbf{z}_0)-\sum_{k=1}^K\ln |\det \pdv{f_k}{\mathbf{z}_{k-1}}|
\end{equation}

이 때, $$f_k$$에 의해 탐색되는 random variables의 path를 \textit{flow}이라고 하며, 이에 대응하는 distributions $$q_k$$의 path를 \textit{normalizing flow}라고 한다. 

Normalizing flow의 길이가 무한인 경우 \textit{infinitesimal flow}라 한다.

This theme supports rendering beautiful math in inline and display modes using [MathJax 3](https://www.mathjax.org/) engine. You just need to surround your math expression with `$$`, like `$$ E = mc^2 $$`. If you leave it inside a paragraph, it will produce an inline expression, just like $$ E = mc^2 $$.

To use display mode, again surround your expression with `$$` and place it as a separate paragraph. Here is an example:

$$
\sum_{k=1}^\infty |\langle x, e_k \rangle|^2 \leq \|x\|^2
$$

You can also use `\begin{equation}...\end{equation}` instead of `$$` for display mode math.
MathJax will automatically number equations:

\begin{equation}
\label{eq:cauchy-schwarz}
\left( \sum_{k=1}^n a_k b_k \right)^2 \leq \left( \sum_{k=1}^n a_k^2 \right) \left( \sum_{k=1}^n b_k^2 \right)
\end{equation}

and by adding `\label{...}` inside the equation environment, we can now refer to the equation using `\eqref`.

Note that MathJax 3 is [a major re-write of MathJax](https://docs.mathjax.org/en/latest/upgrading/whats-new-3.0.html) that brought a significant improvement to the loading and rendering speed, which is now [on par with KaTeX](http://www.intmath.com/cg5/katex-mathjax-comparison.php).
